# Bitcoin Payment Setup Guide

This guide walks through setting up Bitcoin payments for the RAD Crowdfunding template.

## Environment Variables Required

Bitcoin payments require environment variables set in **Convex** (not .env.local):

- `BITCOIN_MASTER_VPRV`: BIP84 testnet extended private key (vprv format) - for development
- `BITCOIN_MASTER_ZPRV`: BIP84 mainnet extended private key (zprv format) - for production
- `BITCOIN_NETWORK`: Either "mainnet" or "testnet"

## Development Setup (Testnet)

### Step 1: Generate Testnet Extended Private Key

**Using Electrum**:

1. **Download and install** [Electrum](https://electrum.org/)

2. **Start Electrum in testnet mode:**
   - **macOS**: Open Terminal and run:
     ```bash
     /Applications/Electrum.app/Contents/MacOS/run_electrum --testnet
     ```
   - **Linux/Windows**:
     ```bash
     electrum --testnet
     ```

3. **Configure testnet network:**
   - You'll see two checkboxes at the bottom: **Proxy** and **Select Electrum Network**
   - Check **"Select Electrum Network"**
   - Choose any testnet server from the list (e.g., `testnet4-electrumx.wakiyamap.dev:51002` `testnet.aranguren.org`, `testnet.qtornado.com`)
   - Click **OK**

4. **Create a new wallet:**
   - Name your wallet (e.g., "crowdfunding-testnet")
   - Select **Standard wallet**
   - Select **Create a new seed**
   - Write down your seed phrase and confirm it
   - Use default SegWit (BIP84) - no need to change anything

5. **Get your vprv key:**
   - Go to **View → Show Console** (or press `Ctrl + \``)
   - In the console at the bottom, type:
     ```python
     wallet.keystore.get_master_private_key(password="")
     ```
   - If your wallet has a password, replace `""` with `"your_password"`
   - Press **Enter**
   - Copy the output (starts with `vprv`)

**IMPORTANT**: This is a TEST key for development only. Never use mainnet keys during development.

**Why Electrum?** Modern Electrum uses BIP84 (native SegWit) by default, which is exactly what this template requires!

### Step 2: Set Convex Environment Variables

**Add to your Convex Development Dashboard:**

```bash
BITCOIN_MASTER_VPRV=vprv...  # Your testnet key from Electrum
BITCOIN_NETWORK=testnet
```

### Step 3: Verify Wallet Compatibility

**CRITICAL**: Before accepting real donations, you MUST verify that addresses generated by our code match your wallet.

#### The Electrum Quirk

Electrum exports vprv/zprv keys with an incorrect depth field in the BIP32 encoding:
- **Key reports**: depth 1 (appears to be at `m/84'`)
- **Key actually represents**: depth 3 (account level `m/84'/0'/0'`)

Our code handles this automatically, but other wallets may export keys differently.

#### Why This Matters

If your wallet uses a different derivation path, addresses generated by our code won't match your wallet. Donations will be sent to addresses you don't see in your wallet UI (though still technically controlled by your master key).

**This can make donations appear "lost" until you figure out the correct derivation path.**

#### Verification Steps

1. **Get your wallet's first 3 addresses:**
   - In Electrum: **View → Show Addresses**
   - Copy the first 3 "Receiving" addresses (should start with `tb1q...` for testnet)

2. **Update the verification script:**
   - Open `verify-wallet-compatibility.ts`
   - Find the `WALLET_ADDRESSES` array (around line 40)
   - Replace the placeholder values with your actual addresses:
     ```typescript
     const WALLET_ADDRESSES = [
         'tb...', // Your address #0
         'tb...', // Your address #1
         'tb...', // Your address #2
     ]
     ```

3. **Run the verification script:**
   ```bash
   BITCOIN_MASTER_VPRV=vprv... npx tsx verify-wallet-compatibility.ts
   ```

4. **Check the results:**
   - ✅ **All addresses match?** You're good to go! Proceed to Step 4.
   - ❌ **Addresses don't match?** See troubleshooting below.

5. **DELETE WALLET_ADDRESS DATA**
   - Open `verify-wallet-compatibility.ts`
   - Find the `WALLET_ADDRESSES` array (around line 40)
   - Remove all of the values and replace with this template:
     ```typescript
     const WALLET_ADDRESSES = [
         'tb...', // Your address #0
         'tb...', // Your address #1
         'tb...', // Your address #2
     ]
     ```

#### If Verification Fails

If addresses don't match, one of these is the issue:

1. **Wrong wallet type**: Your wallet must use BIP84 native SegWit (p2wpkh)
   - In Electrum: Check **Wallet → Information** → "Script Type" should be "p2wpkh"

2. **Wrong network**: Make sure you're comparing testnet addresses to testnet keys
   - Testnet addresses start with `tb...`
   - Mainnet addresses start with `bc...`

3. **Wrong master key**: The vprv/zprv from Electrum console should match what's in Convex
   - Re-run: `wallet.keystore.get_master_private_key(password="")`
   - Compare with: `npx convex env get BITCOIN_MASTER_VPRV`

4. **Non-standard derivation**: Your wallet uses a custom derivation path
   - You may need to update `src/libs/bitcoin/bip84.ts` to match your wallet
   - Or switch to Electrum which we've tested extensively

**⚠️ DO NOT accept real donations until verification passes!**


## Production Setup (Mainnet)

When you're ready to accept real Bitcoin payments:

### Step 1: Generate Mainnet Extended Private Key

**SECURITY WARNING**: This will control real Bitcoin. Take extreme precautions.

1. Use a secure, offline computer if possible
2. Install Electrum on the offline computer
3. Create a new wallet with **default settings** (SegWit/BIP84)
4. Go to **Wallet → Information**
5. Copy the extended private key (starts with `zprv`)
6. **CRITICAL**: Backup your mnemonic phrase securely (physical backup, safe location)

### Step 2: Set Production Environment Variables

**Option A: Convex Dashboard** (Recommended for sensitive keys)

1. Visit https://dashboard.convex.dev
2. Select your project
3. Navigate to "Settings" → "Environment Variables"
4. Add:
   - `BITCOIN_MASTER_ZPRV`: Your mainnet zprv key (production only)
   - `BITCOIN_NETWORK`: `mainnet`

**Option B: Manual CLI**

```bash
# Use production deployment
npx convex env set BITCOIN_MASTER_ZPRV <your-zprv-key> --prod
npx convex env set BITCOIN_NETWORK mainnet --prod
```

**Note:** Production keys should NEVER be in `.env.local` or committed to git.

### Step 3: Verify Production Wallet Compatibility

**⚠️ CRITICAL - DO NOT SKIP THIS STEP ⚠️**

Before accepting real Bitcoin donations, verify your wallet compatibility:

1. **Get your wallet's first 3 mainnet addresses:**
   - In Electrum: Open your **mainnet** wallet (without `--testnet` flag)
   - Go to **View → Show Addresses**
   - Copy the first 3 "Receiving" addresses (should start with `bc1q...`)

2. **Update the verification script:**
   ```typescript
   const WALLET_ADDRESSES = [
       'bc1q...', // Your mainnet address #0
       'bc1q...', // Your mainnet address #1
       'bc1q...', // Your mainnet address #2
   ]
   ```

3. **Run the verification script with your mainnet key:**
   ```bash
   BITCOIN_MASTER_ZPRV=zprv... npx tsx verify-wallet-compatibility.ts
   ```

4. **Verify all 3 addresses match:**
   - ✅ **SUCCESS**: You can safely accept Bitcoin donations
   - ❌ **FAILED**: **DO NOT** go live until this is resolved

5. **DELETE WALLET_ADDRESS DATA**
   - Open `verify-wallet-compatibility.ts`
   - Find the `WALLET_ADDRESSES` array (around line 40)
   - Remove all of the values and replace with this template:
     ```typescript
     const WALLET_ADDRESSES = [
       'bc1q...', // Your mainnet address #0
       'bc1q...', // Your mainnet address #1
       'bc1q...', // Your mainnet address #2
     ]
     ```

**If verification fails:** See the troubleshooting section in the Development Setup above. The same principles apply to mainnet keys.

**Why this matters:** A test payment was sent to the wrong derivation path during development, making it appear "lost" in the wallet. This verification prevents that from happening with real donations.

## Address Derivation

The system uses **BIP84 standard** derivation path (native SegWit):

```
m/84'/0'/0'/0/{index}
```

**Key Details:**
- Uses BIP84 account-level extended keys (zprv for mainnet, vprv for testnet)
- Addresses are derived sequentially starting at index 0
- Each donation generates a unique address
- Counter stored in `bitcoin_config` table (atomic increments)
- Generates bc1... (mainnet) or tb1... (testnet) native SegWit addresses
- Lowest transaction fees compared to legacy or wrapped SegWit

## Recovery Process

If you lose access to your Convex database but have your mnemonic:

1. Restore mnemonic in any BIP84-compatible wallet (Electrum, BlueWallet, Sparrow, etc.)
2. Use derivation path `m/84'/0'/0'/0` (native SegWit)
3. Check the `next_derivation_index` value from your last database backup
4. Scan addresses from index 0 to last known index
5. Sweep funds to a new secure wallet

**Note:** Most modern wallets use BIP84 by default, so standard recovery should work automatically with Electrum.

## Security Best Practices

1. **Never commit** BITCOIN_MASTER_XPRV to version control
2. **Never share** your extended private key or mnemonic
3. Use testnet during all development and testing
4. Keep mnemonic backup in multiple secure physical locations
5. For production, consider using a hardware wallet to generate the master key
6. Regularly monitor derivation index to estimate potential funds at risk
7. Consider setting up automated sweeping to cold storage for large amounts

## Testing Bitcoin Payments

1. pnpm dev to launch your vite and convex
2. navigate to the Donate page
3. Select Bitcoin, then click Open Bitcoin Payment
4. Copy the generated address
5. Get testnet Bitcoin from a faucet:
   - https://mempool.space/testnet4/faucet
6. Send testnet BTC to the generated address
7. Payment should be detected within 10 seconds (polling interval)
4. The Bitcoin modal on our site should show a link to the transaction.

## Payment Monitoring System

Bitcoin payments are monitored using **Convex Schedulers**:

### How It Works

1. **Address Generation**: When user selects Bitcoin payment, a unique address is generated
2. **Schedule Creation**: A schedule is created to monitor the blockchain for this specific address
3. **Polling Interval**: Scheduler checks blockchain every 10 seconds
4. **Auto-Termination**: Scheduler automatically stops when:
   - Payment is confirmed (3+ confirmations)
   - Payment session expires (24 hours after creation)
   - Payment is manually marked as expired

### Scheduler Lifecycle

**Active Monitoring** (status: 'initialized' or 'pending'):
- Scheduler polls blockchain every 10 seconds
- Checks payment status in database before each poll
- Continues until payment confirmed or expired

**Auto-Stop Conditions**:
- Payment status changed to 'confirmed' (donation created)
- Payment status changed to 'expired' (timeout or manual expiration)
- Payment record deleted from database

**Cleanup**:
- Hourly cron job marks expired payments (status: 'expired')
- Schedulers detect status change and stop automatically
- Old expired records deleted after 7 days

## Troubleshooting

**Error: "Failed to fetch BTC price from any exchange"**
- Check internet connection
- Verify API endpoints are accessible (Coinbase, Kraken, Binance)
- Check Convex logs for specific API errors

**Error: "Failed to generate Bitcoin address"**
- Verify BITCOIN_MASTER_VPRV is set correctly
- Verify BITCOIN_NETWORK matches key type (zprv = mainnet, vprv = testnet)
- Check Convex logs for derivation errors

**Error: "Invalid BIP84 key"**
- Ensure key starts with `zprv` (mainnet) or `vprv` (testnet)
- These are BIP84 native SegWit keys from Electrum's default settings
- Verify no extra spaces or characters in env variable

**Error: "Invalid network version"**
- Your key format doesn't match the network setting
- Use `vprv` for testnet, `zprv` for mainnet
- If you have xprv/tprv keys, you need BIP84 format instead

**Payment not detected**
- Check address on block explorer (blockchain.info or testnet.blockchain.info)
- Verify transaction has been broadcast
- Wait for 10-second polling interval
- Check amount sent matches expected BTC amount (within 0.00001 BTC tolerance)
- Verify worker is still active (check Convex dashboard workpool status)

## Additional Resources

- Electrum Wallet: https://electrum.org/
- Testnet Faucets: https://mempool.space/testnet4/faucet
